# Google身份验证器Chrome扩展

## 项目概述
这是一个Google身份验证器Chrome浏览器插件，支持通过二维码扫描导入账户，也支持手动输入密钥。插件可以生成基于时间的一次性密码(TOTP)，用于双因素认证。

## 功能特性
1. 手动输入密钥添加账户
2. 通过摄像头扫描二维码导入账户
3. 扫描页面上的二维码图片
4. 导入二维码图片文件
5. 支持Google Authenticator迁移格式批量导入
6. 显示当前时间窗口的6位验证码
7. 保存多个账户信息
8. 显示账户对应的二维码
9. 自动解析protobuf和明文格式的迁移数据
10. 新页面交互式添加账户
11. 账户列表优先显示，优化用户体验
12. 圆形倒计时器显示剩余时间
13. 一键复制验证码功能
14. 智能账户筛选和搜索
15. 使用频率统计和排序
16. **账户数据导出功能** - 支持JSON格式导出
17. **账户数据导入功能** - 支持JSON格式导入
18. **二维码导出功能** - 生成迁移二维码
19. **数据备份和恢复** - 完整的数据管理功能

## 文件结构
```
chrome-tools/
├── manifest.json          # 扩展配置文件
├── popup.html             # 弹出窗口界面
├── popup.js               # 弹出窗口逻辑
├── add-account.html       # 添加账户新页面
├── add-account.js         # 添加账户页面逻辑
├── background.js          # 后台脚本
├── content.js             # 内容脚本（用于扫描页面二维码）
├── js/
│   ├── authenticator.js   # Google身份验证器算法实现
│   ├── jsQR.js           # 二维码扫描库
│   └── qrcode.min.js     # 二维码生成库
└── icons/
    ├── icon16.png        # 16x16图标
    ├── icon48.png        # 48x48图标
    └── icon128.png       # 128x128图标
```

## 核心功能实现

### 1. TOTP算法实现
- 使用RFC 6238标准实现基于时间的一次性密码算法
- 支持Base32编码的密钥解析
- 使用HMAC-SHA1算法生成令牌

### 2. 二维码功能
- 支持通过摄像头扫描二维码（使用jsQR库）
- 支持扫描页面上的二维码图片
- 支持导入二维码图片文件
- 自动解析Google Authenticator格式的二维码数据
- 支持Google Authenticator迁移格式（otpauth-migration://offline）
- 支持单个账户格式（otpauth://）
- 自动解析protobuf和明文格式的迁移数据
- 支持UTF-8编码的中文账户名称
- 自动批量导入多个账户

### 3. 数据存储
- 使用Chrome扩展的storage API保存账户信息
- 支持多个账户的管理

### 4. 二维码扫描实现
- **动态内容脚本注入**：使用`chrome.scripting.executeScript`动态注入内容脚本
- **多种扫描方式**：
  - 摄像头实时扫描（使用`navigator.mediaDevices.getUserMedia`）
  - 页面图片扫描（使用Canvas和jsQR库）
  - 本地文件导入（使用FileReader API）
- **数据解析**：
  - 优先使用protobuf解析（基于社区OtpMigration.proto定义）
  - 备用明文解析（正则表达式匹配）
  - 混合格式解析（处理特殊情况）
- **UTF-8解码**：使用TextDecoder正确解码中文账户名称
- **消息传递**：通过background script作为中继，确保数据持久化

### 5. 用户界面优化
- **新页面交互**：添加账户功能独立到新页面，提供更好的用户体验
- **账户列表优先**：主页面优先显示账户列表，减少滚动操作
- **圆形倒计时器**：使用SVG实现美观的圆形进度条显示剩余时间
- **一键复制**：点击验证码直接复制到剪贴板
- **智能筛选**：支持按域名、账户名筛选，自动根据当前页面域名筛选
- **使用统计**：记录账户使用频率，智能排序显示
- **响应式设计**：适配不同屏幕尺寸，优化移动端体验

### 6. 账户信息管理
- **issuer信息存储**：支持存储和显示账户的issuer信息
- **智能名称解析**：自动解析`issuer(name)`格式的账户名称
- **迁移数据支持**：完整支持Google Authenticator迁移数据的issuer信息
- **名称去重处理**：智能处理包含issuer信息的账户名称

### 7. 导入导出功能
- **JSON格式导出**：完整导出所有账户数据、使用统计和设置信息
- **JSON格式导入**：支持导入之前导出的备份文件
- **二维码导出**：生成包含所有账户的迁移二维码
- **数据验证**：导入时自动验证数据格式和完整性
- **冲突处理**：智能处理重复账户，避免数据覆盖
- **安全备份**：支持定期备份和恢复账户数据
- **批量操作**：支持批量导入导出多个账户

#### 导出功能实现细节
- **数据收集**：从Chrome Storage API获取所有账户数据、使用统计和设置
- **格式构建**：构建包含版本信息、导出时间、账户数据的JSON结构
- **文件生成**：使用Blob API创建JSON文件，自动生成带日期的文件名
- **下载触发**：通过创建临时下载链接实现文件下载

#### 导入功能实现细节
- **文件读取**：使用FileReader API读取用户选择的JSON文件
- **数据验证**：验证JSON格式、必要字段和数据结构完整性
- **冲突检测**：检查导入账户是否与现有账户重复
- **批量处理**：逐个处理账户数据，跳过重复项，记录处理结果
- **数据保存**：使用Chrome Storage API保存导入的账户数据

#### 二维码导出实现
- **数据准备**：收集所有账户的密钥、名称和issuer信息
- **URL生成**：构建otpauth-migration格式的迁移URL
- **二维码生成**：使用qrcode.js库生成二维码图像
- **弹窗显示**：创建模态窗口显示二维码，支持关闭操作

#### 安全特性
- **数据完整性验证**：导入时验证数据格式和必要字段
- **重复账户处理**：智能跳过重复账户，保护现有数据
- **错误处理**：完善的错误捕获和用户友好的错误提示
- **操作确认**：危险操作（如清空所有数据）需要二次确认

## 使用方法

### 安装扩展
1. 打开Chrome浏览器
2. 进入 `chrome://extensions/`
3. 开启"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择项目目录

### 添加账户
1. 点击扩展图标打开弹出窗口
2. 点击"+ 添加账户"按钮打开新页面
3. 在新页面中：
   - 方法一：手动输入账户名称和密钥，点击"添加账户"
   - 方法二：点击"扫描二维码"扫描页面上的二维码
   - 方法三：点击"导入图片"选择本地二维码图片文件
   - 方法四：拖拽图片到指定区域
4. 添加成功后页面自动关闭，主页面自动刷新
5. 迁移格式会自动批量导入所有账户

### 使用
- 扩展会自动显示当前有效的6位验证码
- 验证码每30秒更新一次，圆形倒计时器显示剩余时间
- 点击验证码可直接复制到剪贴板
- 支持按域名或账户名筛选账户
- 自动根据当前页面域名筛选相关账户
- 使用频率高的账户会优先显示
- 可以管理多个账户，支持删除操作

### 数据管理
- **导出数据**：点击右上角📤按钮导出所有账户数据为JSON文件
- **导入数据**：点击右上角📥按钮导入之前导出的备份文件
- **导出二维码**：在添加账户面板中点击"导出二维码"生成迁移二维码
- **清空数据**：在添加账户面板中点击"清空所有"删除所有账户（需二次确认）
- **备份建议**：建议定期导出数据作为备份，防止数据丢失

## 技术栈
- JavaScript (ES6+)
- Web Crypto API (用于HMAC-SHA1)
- HTML5 Canvas (用于二维码处理)
- Chrome Extension APIs

## 安全考虑
- 所有敏感数据仅在本地存储
- 不向任何外部服务器发送数据
- 使用安全的加密算法实现TOTP

## 依赖库
- jsQR: 用于二维码扫描
- qrcode.js: 用于二维码生成
- Web Crypto API: 用于加密操作

## 导入导出API接口

### 导出功能API
```javascript
// 导出所有账户数据为JSON格式
async function exportAccountsData()

// 导出为二维码格式
async function exportAsQRCode()
```

### 导入功能API
```javascript
// 导入JSON格式的账户数据
async function importAccountsData()

// 验证导入数据格式
function validateImportData(data)

// 处理导入数据
async function processImportData(importData)
```

### 数据管理API
```javascript
// 清空所有账户数据
async function clearAllAccounts()

// 读取文件为文本
function readFileAsText(file)
```

### 导出数据格式
```json
{
  "version": "1.0",
  "exportDate": "2024-01-15T10:30:00.000Z",
  "totalAccounts": 3,
  "accounts": {
    "账户名": {
      "name": "账户名",
      "secret": "密钥",
      "issuer": "发行者",
      "usageCount": 使用次数,
      "lastUsed": 最后使用时间戳
    }
  },
  "accountInfo": {
    "账户名": {
      "issuer": "发行者信息"
    }
  },
  "usageStats": {
    "账户名": {
      "count": 使用次数,
      "lastUsed": 最后使用时间戳
    }
  }
}
```

## 开发历程

### 二维码扫描功能开发（已完成）

#### 第一阶段：基础功能实现
- ✅ 添加摄像头权限到manifest.json
- ✅ 实现动态内容脚本注入
- ✅ 基础二维码扫描功能
- ✅ 页面二维码扫描

#### 第二阶段：Google Authenticator迁移支持
- ✅ 识别otpauth-migration://offline格式
- ✅ 实现protobuf数据解析（基于OtpMigration.proto）
- ✅ 实现明文数据解析（正则表达式）
- ✅ 支持批量账户导入
- ✅ 自动保存到本地存储

#### 第三阶段：用户体验优化
- ✅ 添加二维码图片文件导入功能
- ✅ 实现background script消息中继
- ✅ 优化扫描性能（移除requestAnimationFrame警告）
- ✅ 添加调试按钮和日志

#### 第四阶段：数据解析完善
- ✅ 修复UTF-8中文编码问题
- ✅ 实现混合格式解析
- ✅ 优化字符清理逻辑（保留冒号等符号）
- ✅ 支持原始账户名称显示

#### 技术难点解决
1. **protobuf解析**：实现了完整的protobuf解析器，支持varint、length-delimited等wire types
2. **UTF-8解码**：使用TextDecoder正确解码中文账户名称
3. **消息传递**：通过background script确保数据在popup关闭后仍能保存
4. **性能优化**：使用setTimeout替代requestAnimationFrame减少CPU占用
5. **字符处理**：保留原始格式，只清理控制字符

#### 第四阶段：扫描功能完善
- ✅ 完善页面二维码扫描功能，支持多种载体格式
- ✅ 扩展扫描范围，支持SVG、Canvas、CSS背景图片
- ✅ 优化扫描体验，添加进度反馈和智能通知
- ✅ 增强错误处理，完善跨域处理和错误恢复机制
- ✅ 改进用户界面，集成页面扫描按钮和动画效果

#### 支持的二维码格式
- ✅ Google Authenticator迁移格式（otpauth-migration://offline）
- ✅ 单个账户格式（otpauth://totp/...）
- ✅ 支持中文账户名称
- ✅ 支持特殊字符（冒号、括号等）

#### 支持的扫描载体
- ✅ **图片元素**：JPG、PNG、GIF、WebP等格式的图片
- ✅ **SVG元素**：矢量图形中的二维码
- ✅ **Canvas元素**：动态绘制的二维码
- ✅ **CSS背景图片**：通过样式设置的背景图片中的二维码

### 用户界面优化开发（已完成）

#### 第一阶段：布局优化
- ✅ 账户列表优先显示，减少滚动操作
- ✅ 简化主页面布局，移除冗余按钮
- ✅ 优化头部设计，添加"+ 添加账户"按钮
- ✅ 实现折叠式添加面板

#### 第二阶段：交互体验提升
- ✅ 实现一键复制验证码功能
- ✅ 添加智能账户筛选和搜索
- ✅ 实现使用频率统计和排序
- ✅ 添加自动域名筛选功能

#### 第三阶段：视觉设计优化
- ✅ 实现圆形倒计时器显示剩余时间
- ✅ 优化账户卡片布局和样式
- ✅ 添加菜单式删除操作
- ✅ 实现响应式设计

#### 第四阶段：新页面交互
- ✅ 创建独立的添加账户页面（add-account.html）
- ✅ 实现新页面与主页面的通信机制
- ✅ 优化添加账户的用户体验
- ✅ 支持多种添加方式（手动输入、扫描、导入、拖拽）

#### 第五阶段：账户信息管理
- ✅ 实现issuer信息存储和管理
- ✅ 优化账户名称解析逻辑
- ✅ 支持迁移数据的issuer信息
- ✅ 智能处理重复的issuer信息

#### 技术实现亮点
1. **新页面架构**：独立的添加账户页面，提供更好的用户体验
2. **页面间通信**：通过Chrome扩展消息API实现页面间数据同步
3. **圆形倒计时器**：使用SVG和CSS动画实现美观的进度显示
4. **智能筛选**：基于当前页面域名的自动筛选功能
5. **使用统计**：记录和排序账户使用频率，提升用户体验
6. **一键复制**：集成剪贴板API，支持一键复制验证码
7. **响应式设计**：适配不同屏幕尺寸，优化移动端体验

## 项目总结

### 当前功能状态
- ✅ **核心TOTP功能**：完整的双因素认证支持
- ✅ **二维码扫描**：支持多种扫描方式和格式，包括页面图片扫描
- ✅ **数据迁移**：完整的Google Authenticator迁移支持
- ✅ **用户界面**：现代化的界面设计和交互体验
- ✅ **账户管理**：智能的账户信息管理和显示
- ✅ **性能优化**：高效的数据处理和存储
- ✅ **导入导出功能**：完整的数据备份和恢复支持
- ✅ **数据管理**：支持JSON格式和二维码格式的数据交换
- ✅ **用户体验优化**：滚动位置保持、智能渲染、界面稳定性
- ✅ **扫描功能完善**：多格式支持、智能检测、进度反馈

### 技术特色
1. **完整的Chrome扩展架构**：包含popup、background、content script
2. **先进的二维码处理**：支持protobuf和明文格式解析
3. **现代化的用户界面**：响应式设计，优秀的用户体验
4. **智能的数据管理**：使用统计、自动筛选、排序功能
5. **安全的本地存储**：所有数据仅在本地存储，保护用户隐私
6. **完整的数据备份系统**：支持JSON和二维码格式的导入导出
7. **智能冲突处理**：导入时自动处理重复账户，保护现有数据
8. **用户友好的反馈机制**：完整的操作反馈和错误提示
9. **智能渲染优化**：区分完整渲染和轻量更新，保持界面稳定性
10. **滚动位置保持**：验证码刷新时保持用户查看位置，提升使用体验
11. **多格式扫描支持**：支持图片、SVG、Canvas、CSS背景图片等多种二维码载体
12. **智能扫描检测**：自动识别页面中所有可能的二维码载体元素
13. **实时进度反馈**：扫描过程中提供详细的进度和结果统计

### 适用场景
- 企业双因素认证管理
- 个人账户安全保护
- Google Authenticator数据迁移
- 多账户TOTP管理
- 开发测试环境认证
- 设备更换时的数据迁移
- 定期数据备份和恢复
- 团队账户数据共享
- 跨平台TOTP应用数据交换

### 用户体验优化开发（已完成）

#### 第一阶段：滚动位置修复
- ✅ 修复验证码刷新后滚动位置重置问题
- ✅ 实现滚动位置保存和恢复机制
- ✅ 优化验证码更新逻辑，避免不必要的DOM重建
- ✅ 添加智能渲染策略，区分完整渲染和轻量更新

#### 第二阶段：扫描功能完善
- ✅ 完善页面二维码扫描功能，支持多种载体格式
- ✅ 扩展扫描范围，支持SVG、Canvas、CSS背景图片
- ✅ 优化扫描体验，添加进度反馈和智能通知
- ✅ 增强错误处理，完善跨域处理和错误恢复机制
- ✅ 改进用户界面，集成页面扫描按钮和动画效果

#### 技术实现亮点
1. **滚动位置保持**：在重新渲染前保存滚动位置，渲染后恢复
2. **轻量更新机制**：创建专门的 `updateTokensOnly()` 函数处理验证码更新
3. **智能渲染策略**：根据操作类型选择合适的更新方式
4. **性能优化**：减少DOM操作，提高界面响应速度
5. **用户体验提升**：保持界面稳定性，避免视觉跳动
6. **多格式扫描**：支持图片、SVG、Canvas、CSS背景图片等多种二维码载体
7. **智能检测**：自动识别页面中所有可能的二维码载体元素
8. **进度跟踪**：实时显示扫描进度和结果统计，提供用户反馈

### 导入导出功能开发（已完成）

#### 第一阶段：基础导出功能
- ✅ 实现JSON格式数据导出
- ✅ 支持完整账户数据导出（密钥、issuer、使用统计）
- ✅ 自动生成带日期的备份文件名
- ✅ 集成文件下载功能

#### 第二阶段：导入功能实现
- ✅ 实现JSON格式数据导入
- ✅ 添加数据格式验证和完整性检查
- ✅ 智能处理重复账户，避免数据覆盖
- ✅ 支持批量账户导入

#### 第三阶段：用户界面集成
- ✅ 在头部添加导入导出按钮（📤📥）
- ✅ 在添加账户面板中添加数据管理区域
- ✅ 实现美观的按钮样式和悬停效果
- ✅ 添加完整的用户反馈机制

#### 第四阶段：高级功能
- ✅ 实现二维码导出功能
- ✅ 添加清空所有数据功能（含二次确认）
- ✅ 实现数据验证和错误处理
- ✅ 支持使用统计和设置信息导出

#### 技术实现亮点
1. **数据完整性**：导出包含所有账户数据、使用统计和设置信息
2. **安全验证**：导入时自动验证数据格式和完整性
3. **冲突处理**：智能跳过重复账户，避免数据覆盖
4. **用户体验**：直观的按钮设计和完整的反馈机制
5. **错误处理**：完善的错误处理和用户提示
6. **文件管理**：自动生成有意义的文件名和格式

#### 支持的导出格式
- ✅ **JSON格式**：完整的账户数据备份
- ✅ **二维码格式**：迁移二维码生成
- ✅ **兼容性**：支持与其他TOTP应用的数据交换

### 未来发展方向
- 支持更多认证算法（HOTP、TOTP-SHA256等）
- 添加账户分组和标签功能
- 支持自定义主题和个性化设置
- 添加多语言支持
- 实现云端同步功能（可选）
- 添加账户分享功能

## 版本更新日志

### v1.2.2 - 扫描功能完善版本（2024-01-15）
#### 主要改进
- ✅ **完善页面二维码扫描功能** - 支持扫描浏览器页面中的各种二维码载体
- ✅ **扩展扫描范围** - 支持SVG、Canvas、CSS背景图片等多种格式
- ✅ **优化扫描体验** - 添加进度反馈、智能通知和用户界面改进
- ✅ **增强错误处理** - 完善的跨域处理和错误恢复机制

#### 技术实现
- 新增 `analyzeSVGForQR()` 函数，支持SVG元素扫描
- 新增 `analyzeBackgroundImageForQR()` 函数，支持CSS背景图片扫描
- 改进 `scanPageImages()` 函数，支持更多元素类型和进度跟踪
- 优化 `showNotification()` 函数，支持不同类型的通知显示
- 改进扫描器界面，集成页面扫描按钮和动画效果

#### 扫描功能增强
- **多格式支持**：图片、SVG、Canvas、CSS背景图片
- **智能检测**：自动识别所有可能的二维码载体元素
- **进度反馈**：实时显示扫描进度和结果统计
- **用户界面**：现代化的扫描器界面和操作体验
- **错误处理**：完善的错误恢复和用户提示机制

#### 用户体验提升
- 扫描过程更加直观，有明确的进度提示
- 支持更多场景的二维码扫描需求
- 界面更加美观，操作更加便捷
- 错误提示更加友好和具体

### v1.2.1 - 用户体验优化版本（2024-01-15）
#### 主要改进
- ✅ **修复验证码刷新滚动位置问题** - 验证码刷新后不再跳回顶部
- ✅ **优化验证码更新机制** - 减少不必要的DOM重建，提高性能
- ✅ **智能渲染策略** - 区分完整渲染和轻量更新，保持界面稳定性
- ✅ **滚动位置保持** - 用户查看位置在验证码刷新时保持不变

#### 技术实现
- 新增 `updateTokensOnly()` 函数，专门处理验证码更新
- 在 `displayAccounts()` 中添加滚动位置保存和恢复机制
- 优化定期更新逻辑，从完整重新渲染改为轻量更新
- 添加智能检测机制，确保在必要时才进行完整渲染

#### 用户体验提升
- 验证码刷新时界面保持稳定，无闪烁或跳动
- 用户正在查看的验证码位置不会因刷新而改变
- 减少滚动操作，提高使用效率
- 保持视觉连续性，提升整体体验

### v1.2.0 - 导入导出功能版本（2024-01-15）
#### 新增功能
- ✅ 完整的JSON格式数据导出功能
- ✅ JSON格式数据导入功能
- ✅ 二维码导出功能（生成迁移二维码）
- ✅ 数据验证和完整性检查
- ✅ 智能重复账户处理
- ✅ 清空所有数据功能（含二次确认）
- ✅ 用户界面集成（导入导出按钮）
- ✅ 完整的错误处理和用户反馈

#### 技术改进
- 优化了数据存储结构
- 增强了用户界面交互体验
- 完善了错误处理机制
- 添加了数据安全验证

#### 文档更新
- 新增导入导出功能使用指南
- 更新API接口文档
- 完善技术实现说明

### v1.1.0 - 用户界面优化版本
#### 主要功能
- ✅ 新页面交互式添加账户
- ✅ 圆形倒计时器显示
- ✅ 一键复制验证码功能
- ✅ 智能账户筛选和搜索
- ✅ 使用频率统计和排序
- ✅ 响应式设计优化

### v1.0.0 - 基础功能版本
#### 核心功能
- ✅ TOTP算法实现
- ✅ 二维码扫描功能
- ✅ Google Authenticator迁移支持
- ✅ 账户信息管理
- ✅ 基础用户界面