# Google身份验证器Chrome扩展

## 项目概述
这是一个Google身份验证器Chrome浏览器插件，支持通过二维码扫描导入账户，也支持手动输入密钥。插件可以生成基于时间的一次性密码(TOTP)，用于双因素认证。

## 功能特性
1. 手动输入密钥添加账户
2. 通过摄像头扫描二维码导入账户
3. 扫描页面上的二维码图片
4. 导入二维码图片文件
5. 支持Google Authenticator迁移格式批量导入
6. 显示当前时间窗口的6位验证码
7. 保存多个账户信息
8. 显示账户对应的二维码
9. 自动解析protobuf和明文格式的迁移数据
10. 新页面交互式添加账户
11. 账户列表优先显示，优化用户体验
12. 圆形倒计时器显示剩余时间
13. 一键复制验证码功能
14. 智能账户筛选和搜索
15. 使用频率统计和排序

## 文件结构
```
chrome-tools/
├── manifest.json          # 扩展配置文件
├── popup.html             # 弹出窗口界面
├── popup.js               # 弹出窗口逻辑
├── add-account.html       # 添加账户新页面
├── add-account.js         # 添加账户页面逻辑
├── background.js          # 后台脚本
├── content.js             # 内容脚本（用于扫描页面二维码）
├── js/
│   ├── authenticator.js   # Google身份验证器算法实现
│   ├── jsQR.js           # 二维码扫描库
│   └── qrcode.min.js     # 二维码生成库
└── icons/
    ├── icon16.png        # 16x16图标
    ├── icon48.png        # 48x48图标
    └── icon128.png       # 128x128图标
```

## 核心功能实现

### 1. TOTP算法实现
- 使用RFC 6238标准实现基于时间的一次性密码算法
- 支持Base32编码的密钥解析
- 使用HMAC-SHA1算法生成令牌

### 2. 二维码功能
- 支持通过摄像头扫描二维码（使用jsQR库）
- 支持扫描页面上的二维码图片
- 支持导入二维码图片文件
- 自动解析Google Authenticator格式的二维码数据
- 支持Google Authenticator迁移格式（otpauth-migration://offline）
- 支持单个账户格式（otpauth://）
- 自动解析protobuf和明文格式的迁移数据
- 支持UTF-8编码的中文账户名称
- 自动批量导入多个账户

### 3. 数据存储
- 使用Chrome扩展的storage API保存账户信息
- 支持多个账户的管理

### 4. 二维码扫描实现
- **动态内容脚本注入**：使用`chrome.scripting.executeScript`动态注入内容脚本
- **多种扫描方式**：
  - 摄像头实时扫描（使用`navigator.mediaDevices.getUserMedia`）
  - 页面图片扫描（使用Canvas和jsQR库）
  - 本地文件导入（使用FileReader API）
- **数据解析**：
  - 优先使用protobuf解析（基于社区OtpMigration.proto定义）
  - 备用明文解析（正则表达式匹配）
  - 混合格式解析（处理特殊情况）
- **UTF-8解码**：使用TextDecoder正确解码中文账户名称
- **消息传递**：通过background script作为中继，确保数据持久化

### 5. 用户界面优化
- **新页面交互**：添加账户功能独立到新页面，提供更好的用户体验
- **账户列表优先**：主页面优先显示账户列表，减少滚动操作
- **圆形倒计时器**：使用SVG实现美观的圆形进度条显示剩余时间
- **一键复制**：点击验证码直接复制到剪贴板
- **智能筛选**：支持按域名、账户名筛选，自动根据当前页面域名筛选
- **使用统计**：记录账户使用频率，智能排序显示
- **响应式设计**：适配不同屏幕尺寸，优化移动端体验

### 6. 账户信息管理
- **issuer信息存储**：支持存储和显示账户的issuer信息
- **智能名称解析**：自动解析`issuer(name)`格式的账户名称
- **迁移数据支持**：完整支持Google Authenticator迁移数据的issuer信息
- **名称去重处理**：智能处理包含issuer信息的账户名称

## 使用方法

### 安装扩展
1. 打开Chrome浏览器
2. 进入 `chrome://extensions/`
3. 开启"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择项目目录

### 添加账户
1. 点击扩展图标打开弹出窗口
2. 点击"+ 添加账户"按钮打开新页面
3. 在新页面中：
   - 方法一：手动输入账户名称和密钥，点击"添加账户"
   - 方法二：点击"扫描二维码"扫描页面上的二维码
   - 方法三：点击"导入图片"选择本地二维码图片文件
   - 方法四：拖拽图片到指定区域
4. 添加成功后页面自动关闭，主页面自动刷新
5. 迁移格式会自动批量导入所有账户

### 使用
- 扩展会自动显示当前有效的6位验证码
- 验证码每30秒更新一次，圆形倒计时器显示剩余时间
- 点击验证码可直接复制到剪贴板
- 支持按域名或账户名筛选账户
- 自动根据当前页面域名筛选相关账户
- 使用频率高的账户会优先显示
- 可以管理多个账户，支持删除操作

## 技术栈
- JavaScript (ES6+)
- Web Crypto API (用于HMAC-SHA1)
- HTML5 Canvas (用于二维码处理)
- Chrome Extension APIs

## 安全考虑
- 所有敏感数据仅在本地存储
- 不向任何外部服务器发送数据
- 使用安全的加密算法实现TOTP

## 依赖库
- jsQR: 用于二维码扫描
- qrcode.js: 用于二维码生成
- Web Crypto API: 用于加密操作

## 开发历程

### 二维码扫描功能开发（已完成）

#### 第一阶段：基础功能实现
- ✅ 添加摄像头权限到manifest.json
- ✅ 实现动态内容脚本注入
- ✅ 基础二维码扫描功能
- ✅ 页面二维码扫描

#### 第二阶段：Google Authenticator迁移支持
- ✅ 识别otpauth-migration://offline格式
- ✅ 实现protobuf数据解析（基于OtpMigration.proto）
- ✅ 实现明文数据解析（正则表达式）
- ✅ 支持批量账户导入
- ✅ 自动保存到本地存储

#### 第三阶段：用户体验优化
- ✅ 添加二维码图片文件导入功能
- ✅ 实现background script消息中继
- ✅ 优化扫描性能（移除requestAnimationFrame警告）
- ✅ 添加调试按钮和日志

#### 第四阶段：数据解析完善
- ✅ 修复UTF-8中文编码问题
- ✅ 实现混合格式解析
- ✅ 优化字符清理逻辑（保留冒号等符号）
- ✅ 支持原始账户名称显示

#### 技术难点解决
1. **protobuf解析**：实现了完整的protobuf解析器，支持varint、length-delimited等wire types
2. **UTF-8解码**：使用TextDecoder正确解码中文账户名称
3. **消息传递**：通过background script确保数据在popup关闭后仍能保存
4. **性能优化**：使用setTimeout替代requestAnimationFrame减少CPU占用
5. **字符处理**：保留原始格式，只清理控制字符

#### 支持的二维码格式
- ✅ Google Authenticator迁移格式（otpauth-migration://offline）
- ✅ 单个账户格式（otpauth://totp/...）
- ✅ 支持中文账户名称
- ✅ 支持特殊字符（冒号、括号等）

### 用户界面优化开发（已完成）

#### 第一阶段：布局优化
- ✅ 账户列表优先显示，减少滚动操作
- ✅ 简化主页面布局，移除冗余按钮
- ✅ 优化头部设计，添加"+ 添加账户"按钮
- ✅ 实现折叠式添加面板

#### 第二阶段：交互体验提升
- ✅ 实现一键复制验证码功能
- ✅ 添加智能账户筛选和搜索
- ✅ 实现使用频率统计和排序
- ✅ 添加自动域名筛选功能

#### 第三阶段：视觉设计优化
- ✅ 实现圆形倒计时器显示剩余时间
- ✅ 优化账户卡片布局和样式
- ✅ 添加菜单式删除操作
- ✅ 实现响应式设计

#### 第四阶段：新页面交互
- ✅ 创建独立的添加账户页面（add-account.html）
- ✅ 实现新页面与主页面的通信机制
- ✅ 优化添加账户的用户体验
- ✅ 支持多种添加方式（手动输入、扫描、导入、拖拽）

#### 第五阶段：账户信息管理
- ✅ 实现issuer信息存储和管理
- ✅ 优化账户名称解析逻辑
- ✅ 支持迁移数据的issuer信息
- ✅ 智能处理重复的issuer信息

#### 技术实现亮点
1. **新页面架构**：独立的添加账户页面，提供更好的用户体验
2. **页面间通信**：通过Chrome扩展消息API实现页面间数据同步
3. **圆形倒计时器**：使用SVG和CSS动画实现美观的进度显示
4. **智能筛选**：基于当前页面域名的自动筛选功能
5. **使用统计**：记录和排序账户使用频率，提升用户体验
6. **一键复制**：集成剪贴板API，支持一键复制验证码
7. **响应式设计**：适配不同屏幕尺寸，优化移动端体验

## 项目总结

### 当前功能状态
- ✅ **核心TOTP功能**：完整的双因素认证支持
- ✅ **二维码扫描**：支持多种扫描方式和格式
- ✅ **数据迁移**：完整的Google Authenticator迁移支持
- ✅ **用户界面**：现代化的界面设计和交互体验
- ✅ **账户管理**：智能的账户信息管理和显示
- ✅ **性能优化**：高效的数据处理和存储

### 技术特色
1. **完整的Chrome扩展架构**：包含popup、background、content script
2. **先进的二维码处理**：支持protobuf和明文格式解析
3. **现代化的用户界面**：响应式设计，优秀的用户体验
4. **智能的数据管理**：使用统计、自动筛选、排序功能
5. **安全的本地存储**：所有数据仅在本地存储，保护用户隐私

### 适用场景
- 企业双因素认证管理
- 个人账户安全保护
- Google Authenticator数据迁移
- 多账户TOTP管理
- 开发测试环境认证

### 未来发展方向
- 支持更多认证算法（HOTP、TOTP-SHA256等）
- 添加账户分组和标签功能
- 实现账户备份和恢复
- 支持自定义主题和个性化设置
- 添加多语言支持